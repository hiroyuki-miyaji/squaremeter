<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
    }
    .controls {
        padding: 10px;
        background: #f4f4f4;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    #address-input {
        padding: 8px;
        border: 1px solid #ccc;
        flex-grow: 3;
        max-width: 600px;
    }
    #search-button {
        padding: 8px 15px;
        background-color: #0078d4;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
    }

    /* ğŸ“± ã‚¹ãƒãƒ›å¯¾å¿œï¼šé«˜ã•ãŒã‚¼ãƒ­ã«ãªã‚‰ãªã„ã‚ˆã†ã« */
    #map-container {
        display: flex;
        height: calc(100vh - 140px);
        min-height: 400px;
        overflow: hidden;
    }
    #map {
        width: 70%;
        height: 100%;
    }
    #sidebar {
        width: 30%;
        height: 100%;
        overflow-y: auto;
        padding: 15px;
        border-left: 1px solid #ccc;
        background-color: #fff;
    }

    @media (max-width: 768px) {
        #map-container {
            flex-direction: column;
            height: calc(100vh - 140px);
        }
        #map {
            width: 100%;
            height: 60%;
        }
        #sidebar {
            width: 100%;
            height: 40%;
        }
    }

    .suitable { color: #1e8449; font-weight: bold; }
    .unsuitable { color: #c0392b; font-weight: bold; }
    .conditional { color: #f39c12; font-weight: bold; }

    .candidate-item {
        border-bottom: 1px dashed #eee;
        padding: 8px 0;
        cursor: pointer;
    }
    .candidate-item:hover {
        background-color: #f9f9f9;
    }
    .disaster-links-popup a {
        display: block;
        margin-top: 5px;
        color: #0078d4;
        text-decoration: underline;
    }
</style>

</head>
<body>

<h2>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</h2>
<a href="https://hiroyuki-miyaji.github.io/squaremeter/%E3%81%BF%E3%82%93%E3%81%AA%E3%81%AE%E9%98%B2%E7%81%BD%E5%80%89%E5%BA%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%9E%E3%83%83%E3%83%97.html">ã¿ã‚“ãªã®é˜²ç½å€‰åº«ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—<a/>
<div class="controls">
    <input type="text" id="address-input" placeholder="åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã€ã¾ãŸã¯ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    <button id="search-button">å€™è£œåœ°ã‚’æ¤œç´¢</button>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="sidebar">
        <h3>å€™è£œåœ°ä¸€è¦§</h3>
        <div id="candidates-list">çµæœã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
</div>

<script>
let map;
let currentInfoWindow = null;
let markers = [];
const API_KEY = "AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A";

const LOGIC_APP_URL =
 "https://prod-47.japaneast.logic.azure.com:443/workflows/690c844c958e440b959b6723c69c5ef8/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=Gy1WOfIlVTGYqj1DsclsX0Uai1yZyugwuMdL425NOxU";

function getIconUrl(suitability) {
    const base = "http://maps.google.com/mapfiles/ms/icons/";
    if (suitability === "é©åˆ") return base + "green-dot.png";
    if (suitability === "ä¸é©åˆ") return base + "red-dot.png";
    if (suitability === "æ¡ä»¶ä»˜ã") return base + "yellow-dot.png";
    return base + "blue-dot.png";
}

/* ğŸ“ åˆæœŸè¡¨ç¤ºï¼šGPS å–å¾— â†’ å¤±æ•—ã—ãŸã‚‰æ±äº¬é§… */
function initMap() {
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const center = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            };
            createMap(center);
        },
        () => {
            createMap({ lat: 34.3911, lng: 132.4576 });
        }
    );
}

function createMap(center) {
    map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 13
    });

    placeCenterMarker(center);

    /* ã‚¹ãƒãƒ›å‘ã‘ resize */
    setTimeout(() => {
        google.maps.event.trigger(map, "resize");
        map.setCenter(center);
    }, 500);

    document.getElementById("search-button").onclick = searchWarehouse;
    map.addListener("click", handleMapClick);
}

function placeCenterMarker(position) {
    new google.maps.Marker({
        position,
        map,
        title: "æ¤œç´¢ä¸­å¿ƒåœ°",
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    });
}

/* ğŸ“ã‚¯ãƒªãƒƒã‚¯ã§é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
async function handleMapClick(event) {
    const latlng = event.latLng;
    const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latlng.lat()},${latlng.lng()}&key=${API_KEY}&language=ja`;

    document.getElementById("address-input").value = "ä½æ‰€ã‚’æ¤œç´¢ä¸­...";

    const res = await fetch(url);
    const data = await res.json();

    if (data.results?.length > 0) {
        document.getElementById("address-input").value =
            data.results[0].formatted_address;
    }
}

async function searchWarehouse() {
    const address = document.getElementById('address-input').value.trim();
    if (!address || address.includes("æ¤œç´¢ä¸­") || address.includes("å¤±æ•—")) {
        alert('æœ‰åŠ¹ãªä½æ‰€ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    document.getElementById('search-button').textContent = 'æ¤œç´¢ä¸­...';
    document.getElementById('candidates-list').innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';

    let data;

	try {
		const response = await fetch(LOGIC_APP_URL, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ address: address })
		});

		if (!response.ok) {
			throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
		}

		const jsonText = await response.text();  // â† text() ã§å—ã‘å–ã‚‹

		let cleanJsonText = jsonText.trim();
		if (cleanJsonText.startsWith('"') && cleanJsonText.endsWith('"')) {
			cleanJsonText = cleanJsonText.slice(1, -1);
		}

		// ä¸è¦ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‰Šé™¤
		cleanJsonText = cleanJsonText.replace(/\\"/g, '"');

		// JSONã«å¤‰æ›
		data = JSON.parse(cleanJsonText);

		if (Array.isArray(data)) {
			placeMarkers(data);
		} else {
			console.error("Unexpected response:", data);
			document.getElementById('candidates-list').innerHTML =
				`<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
			placeMarkers([]);
		}

	} catch (error) {
		console.error("Fetch/Parse error:", error);
		document.getElementById('candidates-list').innerHTML =
			`<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
		placeMarkers([]);
	} finally {
		document.getElementById('search-button').textContent = 'å€™è£œåœ°ã‚’æ¤œç´¢';
	}

}

function placeMarkers(locations) {
    markers.forEach((m) => m.setMap(null));
    markers = [];

    const listElement = document.getElementById("candidates-list");
    listElement.innerHTML = "";

    if (!locations.length) {
        listElement.textContent = "å€™è£œåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    map.panTo({ lat: parseFloat(locations[0].lat), lng: parseFloat(locations[0].lng) });
    map.setZoom(15);

    locations.forEach((loc, index) => {
        const pos = { lat: parseFloat(loc.lat), lng: parseFloat(loc.lng) };

        const marker = new google.maps.Marker({
            position: pos,
            map,
            title: loc.name,
            icon: getIconUrl(loc.suitability)
        });

        markers.push(marker);

        const infoHtml = `
        <div>
            <h3>${loc.name}</h3>
            <p><strong>ä½æ‰€:</strong> ${loc.address}</p>
            <p><strong>é©æ€§:</strong> ${loc.suitability}</p>
            <p>${loc.reason}</p>

            <hr>
            <strong>å‘¨è¾ºé˜²ç½æƒ…å ±:</strong><br>
            <a href="https://www.jma.go.jp/bosai/risk/#zoom:14/lat:${pos.lat}/lon:${pos.lng}" target="_blank">ã‚­ã‚­ã‚¯ãƒ«</a><br>
            <a href="https://disaportal.gsi.go.jp/hazardmap/maps/index.html?ll=${pos.lat},${pos.lng}&z=15" target="_blank">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</a><br>
            <a href="https://www.google.com/maps/search/é¿é›£æ‰€/@${pos.lat},${pos.lng},15z" target="_blank">é¿é›£æ‰€æ¤œç´¢</a><br>

            <!-- â˜…ä¿®æ­£æ¸ˆã¿ AED ãƒªãƒ³ã‚¯ -->
            <a href="https://aedm.jp/" target="_blank">è¿‘éš£ã®AED</a><br>

            <!-- â˜…ç·¯åº¦çµŒåº¦å…¥ã‚Š å…¬è¡†é›»è©±ãƒªãƒ³ã‚¯ -->
            <a href="https://www.locationsmart.org/?tag=_collabo_phonebooth_ntt&lat=${pos.lat}&lon=${pos.lng}&z=18" target="_blank">
                å…¬è¡†é›»è©±ï¼ˆæœ€å¯„ã‚Šï¼‰
            </a>
        </div>
        `;

        const iw = new google.maps.InfoWindow({ content: infoHtml });

        marker.addListener("click", () => {
            if (currentInfoWindow) currentInfoWindow.close();
            iw.open(map, marker);
            currentInfoWindow = iw;
        });

        const item = document.createElement("div");
        item.className = "candidate-item";
        item.innerHTML = `<strong>${index + 1}. ${loc.name}</strong><br>${loc.address}`;
        item.onclick = () => {
            map.panTo(pos);
            map.setZoom(16);
            if (currentInfoWindow) currentInfoWindow.close();
            iw.open(map, marker);
            currentInfoWindow = iw;
        };
        listElement.appendChild(item);
    });
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A&callback=initMap"></script>
</body>
</html>
