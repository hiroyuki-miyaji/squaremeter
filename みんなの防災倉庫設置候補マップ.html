<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100vh;
        }
        .controls {
            padding: 10px;
            background: #f4f4f4;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #address-input {
            padding: 8px;
            border: 1px solid #ccc;
            flex-grow: 3; 
            max-width: 600px; 
        }
        #search-button {
            padding: 8px 15px;
            background-color: #0078d4;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        #map-container {
            display: flex;
            height: 80vh; 
            min-height: 400px;
            overflow: hidden;
        }
        #map {
            width: 70%;
            background-color: #e0e0e0;
        }
        #sidebar {
            width: 30%;
            padding: 15px;
            overflow-y: auto;
            border-left: 1px solid #ccc;
            background-color: #ffffff;
        }
        .info-window h3 { margin-top: 0; color: #0078d4; }
        .suitable { color: #1e8449; font-weight: bold; }
        .unsuitable { color: #c0392b; font-weight: bold; }
        .conditional { color: #f39c12; font-weight: bold; }

        .candidate-item {
            border-bottom: 1px dashed #eee;
            padding: 8px 0;
            cursor: pointer;
        }
        .candidate-item:hover {
            background-color: #f9f9f9;
        }

        .disaster-links-popup a {
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
            color: #0078d4;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h2>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</h2>
	<a href="https://hiroyuki-miyaji.github.io/squaremeter/ã¿ã‚“ãªã®é˜²ç½å€‰åº«ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—.html">ã¿ã‚“ãªã®é˜²ç½å€‰åº«ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—</a><br>
    <div class="controls">
        <input type="text" id="address-input" placeholder="åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã€ã¾ãŸã¯ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        <button id="search-button">å€™è£œåœ°ã‚’æ¤œç´¢</button>
    </div>
    
    <div id="map-container">
        <div id="map"></div>
        <div id="sidebar">
            <h3>å€™è£œåœ°ä¸€è¦§</h3>
            <div id="candidates-list">çµæœã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
    </div>

    <script>
        let map;
        let currentInfoWindow = null;
        let markers = []; 
        const API_KEY = 'AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A';
        const TOKYO_CENTER = { lat: 35.6895, lng: 139.6917 }; // æ±äº¬é§…å‘¨è¾º

        // ğŸš¨ Logic Appsã®å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’JavaScriptæ–‡å­—åˆ—ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€ ğŸš¨
        const LOGIC_APP_URL = "https://prod-47.japaneast.logic.azure.com:443/workflows/690c844c958e440b959b6723c69c5ef8/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=Gy1WOfIlVTGYqj1DsclsX0Uai1yZyugwuMdL425NOxU";

        // ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’é©æ€§ã«åˆã‚ã›ã¦å¤‰ãˆã‚‹é–¢æ•°
        function getIconUrl(suitability) {
            // Google Mapsã®ãƒãƒ£ãƒ¼ãƒˆURLã§ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’æŒ‡å®š
            const baseURL = 'http://maps.google.com/mapfiles/ms/icons/';
            switch (suitability) {
                case 'é©åˆ':
                    return baseURL + 'green-dot.png';
                case 'ä¸é©åˆ':
                    return baseURL + 'red-dot.png';
                case 'æ¡ä»¶ä»˜ã':
                    return baseURL + 'yellow-dot.png';
                default:
                    return baseURL + 'blue-dot.png';
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: TOKYO_CENTER,
                zoom: 12
            });

            document.getElementById('search-button').addEventListener('click', searchWarehouse);
            
            map.addListener('click', handleMapClick);

            placeCenterMarker(TOKYO_CENTER);
        }
        
        function handleMapClick(event) {
            const latlng = event.latLng;
            geocodeLatLng(latlng);
        }

        async function geocodeLatLng(latlng) {
            document.getElementById('address-input').value = "ä½æ‰€ã‚’æ¤œç´¢ä¸­...";
            
            const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latlng.lat()},${latlng.lng()}&key=${API_KEY}&language=ja`; 

            try {
                const response = await fetch(geocodeUrl);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const address = data.results[0].formatted_address;
                    document.getElementById('address-input').value = address;
                } else {
                    document.getElementById('address-input').value = "ä½æ‰€ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                }
            } catch (error) {
                console.error("é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('address-input').value = "ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            }
        }
        
        function placeCenterMarker(position) {
             new google.maps.Marker({
                position: position,
                map: map,
                title: "æ¤œç´¢ä¸­å¿ƒåœ°",
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
        }

        async function searchWarehouse() {
            const address = document.getElementById('address-input').value.trim();
            if (!address || address.includes("æ¤œç´¢ä¸­") || address.includes("å¤±æ•—")) {
                alert('æœ‰åŠ¹ãªä½æ‰€ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            document.getElementById('search-button').textContent = 'æ¤œç´¢ä¸­...';
            document.getElementById('candidates-list').innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
            
            let data; // ğŸ’¡ä¿®æ­£: dataå¤‰æ•°ã‚’tryãƒ–ãƒ­ãƒƒã‚¯ã®å¤–ã§å®šç¾©

            try {
                const response = await fetch(LOGIC_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ address: address }) 
                });

                if (!response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
                }

                const jsonText = await response.text();

                // ğŸ’¡ä¿®æ­£: Logic Appsã®å¿œç­”ã§ä»˜åŠ ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ä½™åˆ†ãªå¼•ç”¨ç¬¦ã‚’å‰Šé™¤
                let cleanJsonText = jsonText.trim();
                if (cleanJsonText.startsWith('"') && cleanJsonText.endsWith('"')) {
                    cleanJsonText = cleanJsonText.substring(1, cleanJsonText.length - 1);
                }

                data = JSON.parse(cleanJsonText);
                
                if (Array.isArray(data)) {
                    placeMarkers(data);
                } else {
                    console.error("âŒ äºˆæœŸã—ãªã„å¿œç­”å½¢å¼:", data);
                    document.getElementById('candidates-list').innerHTML = `<p style="color: red;">ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚JSONé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
                    placeMarkers([]); // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                }

            } catch (error) {
                console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—/ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById('candidates-list').innerHTML = `<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
                placeMarkers([]); // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            } finally {
                document.getElementById('search-button').textContent = 'å€™è£œåœ°ã‚’æ¤œç´¢';
            }
        }

        function placeMarkers(locations) {
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            if (locations.length === 0) {
                if (document.getElementById('candidates-list').innerHTML === 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...') {
                     document.getElementById('candidates-list').innerHTML = 'å€™è£œåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                }
                return;
            }

            const listElement = document.getElementById('candidates-list');
            listElement.innerHTML = ''; 
            
            // æœ€åˆã®å€™è£œåœ°ã®åº§æ¨™ã«åœ°å›³ã‚’ç§»å‹• (å®‰å…¨ã®ãŸã‚ã«LatLngã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ)
            const firstLat = parseFloat(locations[0].lat);
            const firstLng = parseFloat(locations[0].lng);

            if (!isNaN(firstLat) && !isNaN(firstLng)) {
                const firstPosition = { lat: firstLat, lng: firstLng };
                map.panTo(firstPosition);
                map.setZoom(14);
            }
            
            locations.forEach((location, index) => {
                const lat = parseFloat(location.lat);
                const lng = parseFloat(location.lng);
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn(`ç„¡åŠ¹ãªåº§æ¨™ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${location.name}`);
                    return;
                }

                const position = { lat: lat, lng: lng };

                const marker = new google.maps.Marker({
                    position,
                    map,
                    title: location.name,
                    icon: getIconUrl(location.suitability)
                });
                
                markers.push(marker);

                const suitabilityClass = location.suitability === 'é©åˆ' ? 'suitable' : location.suitability === 'ä¸é©åˆ' ? 'unsuitable' : 'conditional';
                
                // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®HTMLã‚’ç”Ÿæˆ
                const infoWindowContent = `
                    <div class="info-window">
                        <h3>${location.name}</h3>
                        <p><strong>ä½æ‰€:</strong> ${location.address || 'æ¨å®šä½æ‰€æƒ…å ±ãªã—'}</p>
                        <p><strong>é©æ€§è©•ä¾¡:</strong> <span class="${suitabilityClass}">${location.suitability}</span></p>
                        <p><strong>ç†ç”±:</strong> ${location.reason}</p>
                        <div class="disaster-links-popup">
                            <hr>
                            <strong>å‘¨è¾ºé˜²ç½æƒ…å ±:</strong>
                            <a href="https://www.jma.go.jp/bosai/risk/#zoom:14/lat:${lat}/lon:${lng}" target="_blank">ã‚­ã‚­ã‚¯ãƒ« (å±é™ºåº¦ãƒãƒƒãƒ—)</a>
                            <a href="https://disaportal.gsi.go.jp/hazardmap/maps/index.html?ll=${lat},${lng}&z=15" target="_blank">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ— (å›½åœŸåœ°ç†é™¢)</a>
                            <a href="https://www.google.com/maps/search/%E9%81%BF%E9%9B%A3%E6%89%80/@${lat},${lng},14z" target="_blank">å‘¨è¾ºé¿é›£æ‰€ã‚’æ¤œç´¢</a>
                            <a href="https://aedm.jp/search/" target="_blank">å‘¨è¾ºã®AEDã‚’æ¤œç´¢ (AED NIPPON)</a>
                            <a href="https://public-phone.ntt-east.co.jp/" target="_blank">å‘¨è¾ºã®å…¬è¡†é›»è©±ã‚’æ¤œç´¢</a>
                        </div>
                    </div>`;

                const infoWindow = new google.maps.InfoWindow({ content: infoWindowContent });

                marker.addListener("click", () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;
                });
                
                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                const listItem = document.createElement('div');
                listItem.className = 'candidate-item';
                listItem.innerHTML = `
                    <strong>${index + 1}. ${location.name}</strong> 
                    <span class="${suitabilityClass}">(${location.suitability})</span><br>
                    <small>${location.address || 'ä½æ‰€æƒ…å ±ãªã—'}</small>
                `;
                listItem.onclick = () => {
                    map.panTo(position); 
                    if (currentInfoWindow) currentInfoWindow.close();
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;
                };
                listElement.appendChild(listItem);
            });
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A&callback=initMap"></script>
</body>

</html>

