<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
    }

    .controls {
        padding: 10px;
        background: #f4f4f4;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #address-input {
        padding: 8px;
        border: 1px solid #ccc;
        flex-grow: 3;
        max-width: 600px;
    }

    #search-button {
        padding: 8px 15px;
        background-color: #0078d4;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
    }

    /* --- PC ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰--- */
    #map-container {
        display: flex;
        flex-direction: row; /* â† PC ã¯æ¨ªä¸¦ã³ */
        height: calc(100vh - 140px);
        min-height: 400px;
        width: 100%;
        overflow: hidden;
    }

    #map {
        flex: 7;
        height: 100%;
    }

    #sidebar {
        flex: 3;
        height: 100%;
        overflow-y: auto;
        padding: 15px;
        border-left: 1px solid #ccc;
        background-color: #fff;
    }

    /* --- ã‚¹ãƒãƒ›ç”¨ï¼ˆ768pxä»¥ä¸‹ï¼‰--- */
    @media (max-width: 768px) {
        #map-container {
            flex-direction: column;  /* â† ç¸¦ä¸¦ã³ */
            height: calc(100vh - 140px);
        }

        #map {
            width: 100%;
            height: 60vh;  /* â† åœ°å›³ãŒ0ã«ãªã‚‰ãªã„ã‚ˆã†ã«çµ¶å¯¾å€¤æŒ‡å®š */
        }

        #sidebar {
            width: 100%;
            height: 40vh;
            border-left: none;
            border-top: 1px solid #ccc;
        }
    }

    .suitable { color: #1e8449; font-weight: bold; }
    .unsuitable { color: #c0392b; font-weight: bold; }
    .conditional { color: #f39c12; font-weight: bold; }

    .candidate-item {
        border-bottom: 1px dashed #eee;
        padding: 8px 0;
        cursor: pointer;
    }

    .candidate-item:hover {
        background-color: #f9f9f9;
    }

    .disaster-links-popup a {
        display: block;
        margin-top: 5px;
        color: #0078d4;
        text-decoration: underline;
    }
</style>


</head>
<body>

<h2>ã¿ã‚“ãªã®é˜²ç½å€‰åº«å€™è£œåœ°ãƒãƒƒãƒ—</h2>
<a href="https://hiroyuki-miyaji.github.io/squaremeter/%E3%81%BF%E3%82%93%E3%81%AA%E3%81%AE%E9%98%B2%E7%81%BD%E5%80%89%E5%BA%AB%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%9E%E3%83%83%E3%83%97.html">ã¿ã‚“ãªã®é˜²ç½å€‰åº«ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ—<a/>
<div class="controls">
    <input type="text" id="address-input" placeholder="åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã€ã¾ãŸã¯ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    <button id="search-button">å€™è£œåœ°ã‚’æ¤œç´¢</button>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="sidebar">
        <h3>å€™è£œåœ°ä¸€è¦§</h3>
        <div id="candidates-list">çµæœã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>
</div>

<script>
let map;
let currentInfoWindow = null;
let markers = [];
const API_KEY = "AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A";

const LOGIC_APP_URL =
 "https://prod-47.japaneast.logic.azure.com:443/workflows/690c844c958e440b959b6723c69c5ef8/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=Gy1WOfIlVTGYqj1DsclsX0Uai1yZyugwuMdL425NOxU";

function getIconUrl(suitability) {
    const base = "http://maps.google.com/mapfiles/ms/icons/";
    if (suitability === "é©åˆ") return base + "green-dot.png";
    if (suitability === "ä¸é©åˆ") return base + "red-dot.png";
    if (suitability === "æ¡ä»¶ä»˜ã") return base + "yellow-dot.png";
    return base + "blue-dot.png";
}

/* ğŸ“ åˆæœŸè¡¨ç¤ºï¼šGPS å–å¾— â†’ å¤±æ•—ã—ãŸã‚‰æ±äº¬é§… */
function initMap() {
	// ğŸ” Enterã‚­ãƒ¼ã§åœ°å›³ã‚’ä¸­å¿ƒã«
	document.getElementById("address-input").addEventListener("keydown", (e) => {
		if (e.key === "Enter") {
			centerMapFromTextbox();
		}
	});

	// ğŸ” ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã‚‚ä¸­å¿ƒã«
	document.getElementById("address-input").addEventListener("blur", () => {
		centerMapFromTextbox();
	});
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const center = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
            };
            createMap(center);
        },
        () => {
            createMap({ lat: 34.3911, lng: 132.4576 });
        }
    );
}

function createMap(center) {
    map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 13
    });

    placeCenterMarker(center);

    /* ã‚¹ãƒãƒ›å‘ã‘ resize */
    setTimeout(() => {
        google.maps.event.trigger(map, "resize");
        map.setCenter(center);
    }, 500);

    document.getElementById("search-button").onclick = searchWarehouse;
    map.addListener("click", handleMapClick);
}

function placeCenterMarker(position) {
    new google.maps.Marker({
        position,
        map,
        title: "æ¤œç´¢ä¸­å¿ƒåœ°",
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    });
}

/* ğŸ“ã‚¯ãƒªãƒƒã‚¯ã§é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
async function handleMapClick(event) {
    const latlng = event.latLng;
    const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latlng.lat()},${latlng.lng()}&key=${API_KEY}&language=ja`;

    document.getElementById("address-input").value = "ä½æ‰€ã‚’æ¤œç´¢ä¸­...";

    const res = await fetch(url);
    const data = await res.json();

    if (data.results?.length > 0) {
        document.getElementById("address-input").value =
            data.results[0].formatted_address;
    }
}

async function searchWarehouse() {
    const address = document.getElementById('address-input').value.trim();
	//éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘åˆ‡ã‚Šå‡ºã—
    const parsed = parseJapaneseAddress(address);
    const payload = {
        address: address,
        prefecture: parsed.pref,
        city: parsed.city
    };	
	
    if (!address || address.includes("æ¤œç´¢ä¸­") || address.includes("å¤±æ•—")) {
        alert('æœ‰åŠ¹ãªä½æ‰€ã‚’å…¥åŠ›ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    document.getElementById('search-button').textContent = 'æ¤œç´¢ä¸­...';
    document.getElementById('candidates-list').innerHTML = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';

    let data;

	try {
		const response = await fetch(LOGIC_APP_URL, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(payload)
		});

		if (!response.ok) {
			throw new Error(`HTTPã‚¨ãƒ©ãƒ¼! ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`);
		}

		const jsonText = await response.text();  // â† text() ã§å—ã‘å–ã‚‹

		let cleanJsonText = jsonText.trim();
		if (cleanJsonText.startsWith('"') && cleanJsonText.endsWith('"')) {
			cleanJsonText = cleanJsonText.slice(1, -1);
		}

		// ä¸è¦ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‰Šé™¤
		cleanJsonText = cleanJsonText.replace(/\\"/g, '"');

		// JSONã«å¤‰æ›
		data = JSON.parse(cleanJsonText);

		if (Array.isArray(data)) {
			placeMarkers(data);
		} else {
			console.error("Unexpected response:", data);
			document.getElementById('candidates-list').innerHTML =
				`<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
			placeMarkers([]);
		}

	} catch (error) {
		console.error("Fetch/Parse error:", error);
		document.getElementById('candidates-list').innerHTML =
			`<p style="color:red;">ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
		placeMarkers([]);
	} finally {
		document.getElementById('search-button').textContent = 'å€™è£œåœ°ã‚’æ¤œç´¢';
	}

}

function placeMarkers(locations) {
    markers.forEach((m) => m.setMap(null));
    markers = [];

    const listElement = document.getElementById("candidates-list");
    listElement.innerHTML = "";

    if (!locations.length) {
        listElement.textContent = "å€™è£œåœ°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    map.panTo({ lat: parseFloat(locations[0].lat), lng: parseFloat(locations[0].lng) });
    map.setZoom(15);

    locations.forEach((loc, index) => {
        const pos = { lat: parseFloat(loc.lat), lng: parseFloat(loc.lng) };

        const marker = new google.maps.Marker({
            position: pos,
            map,
            title: loc.name,
            icon: getIconUrl(loc.suitability)
        });

        markers.push(marker);

        const infoHtml = `
        <div>
            <h3>${loc.name}</h3>
            <p><strong>ä½æ‰€:</strong> ${loc.address}</p>
            <p><strong>é©æ€§:</strong> ${loc.suitability}</p>
            <p>${loc.reason}</p>
            <p>${loc.stockpiles}</p>

            <hr>
            <strong>å‘¨è¾ºé˜²ç½æƒ…å ±:</strong><br>
            <a href="https://www.jma.go.jp/bosai/risk/#zoom:14/lat:${pos.lat}/lon:${pos.lng}" target="_blank">ã‚­ã‚­ã‚¯ãƒ«</a><br>
            <a href="https://disaportal.gsi.go.jp/hazardmap/maps/index.html?ll=${pos.lat},${pos.lng}&z=15&base=pale&ls=Disaster_lore_all&disp=1&vs=c1j0l0u0t0h0z0" target="_blank">éå»ã®ç½å®³ä¼æ‰¿ç¢‘</a><br>
			<a href="https://disaportal.gsi.go.jp/hazardmap/maps/index.html?ll=${pos.lat},${pos.lng}&z=15&base=pale&ls=tameike_raster%2C0.8%7Cnaisui_raster%2C0.8%7Cflood_l2_kaokutoukai_kagan%2C0.8%7Cflood_l2_kaokutoukai_hanran%2C0.8%7Cflood_l2_keizoku%2C0.8%7Cflood_list%2C0.8%7Cflood_l1%2C0.8%7Cflood_list_l2%2C0.75%7Cdosha_kiken_nadare%2C0.8%7Cdosha_keikai_jisuberi%2C0.8%7Cdosha_keikai_dosekiryu%2C0.8%7Cdosha_keikai_kyukeisha%2C0.8%7Ctakashio_sinsuisin_raster%2C0.8%7Cekijouka_zenkoku%2C0.8%7Ctsunamishinsui_raster%2C0.8%7Cdisaster1%7Cdisaster2%7Cdisaster3%7Cdisaster5&disp=1100000101111010000&vs=c1j0l0u0t0h0z0 target="_blank">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—</a><br>
            <a href="https://disaportal.gsi.go.jp/hazardmap/maps/index.html?ll=${pos.lat},${pos.lng}&z=15&base=pale&ls=disaster1%7Cdisaster7%7Cdisaster5%7Cdisaster2%7Cdisaster4%7Cdisaster6%7Cdisaster8%7Cdisaster3&disp=00010000&vs=c1j0l0u0t0h0z0" target="_blank">æŒ‡å®šç·Šæ€¥é¿é›£æ‰€</a><br>
            <a href="https://www.google.com/maps/search/é¿é›£æ‰€/@${pos.lat},${pos.lng},15z" target="_blank">Googlemapé¿é›£æ‰€æ¤œç´¢</a><br>
            <!-- â˜…ä¿®æ­£æ¸ˆã¿ AED ãƒªãƒ³ã‚¯ -->
            <a href="https://aedm.jp/" target="_blank">è¿‘éš£ã®AED</a><br>
            <!-- â˜…ç·¯åº¦çµŒåº¦å…¥ã‚Š å…¬è¡†é›»è©±ãƒªãƒ³ã‚¯ -->
            <a href="https://www.locationsmart.org/?tag=_collabo_phonebooth_ntt&lat=${pos.lat}&lon=${pos.lng}&z=18" target="_blank">
                å…¬è¡†é›»è©±ï¼ˆæœ€å¯„ã‚Šï¼‰
            </a>
        </div>
        `;

        const iw = new google.maps.InfoWindow({ content: infoHtml });

        marker.addListener("click", () => {
            if (currentInfoWindow) currentInfoWindow.close();
            iw.open(map, marker);
            currentInfoWindow = iw;
        });

		const item = document.createElement("div");
		item.className = "candidate-item";

		const iconUrl = getIconUrl(loc.suitability);

		// é©æ€§ã«å¿œã˜ãŸè¡¨ç¤ºè‰²ã‚¯ãƒ©ã‚¹
		const suitabilityClass =
			loc.suitability === "é©åˆ"
				? "suitable"
				: loc.suitability === "ä¸é©åˆ"
				? "unsuitable"
				: "conditional";

		item.innerHTML = `
			<div style="display:flex; gap:8px; align-items:flex-start;">
				<img src="${iconUrl}" width="20" height="20">

				<div>
					<strong>${index + 1}. ${loc.name}</strong><br>
					<span class="${suitabilityClass}">${loc.suitability}</span><br>
					<small>${loc.address}</small>
				</div>
			</div>
		`;

		item.onclick = () => {
			map.panTo(pos);
			map.setZoom(16);
			if (currentInfoWindow) currentInfoWindow.close();
			iw.open(map, marker);
			currentInfoWindow = iw;
		};

		listElement.appendChild(item);
    });
}
	/* ğŸ“Œ ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ä½æ‰€ã‚’åœ°å›³ä¸­å¤®ã«ç§»å‹• */
	async function centerMapFromTextbox() {
		const address = document.getElementById("address-input").value.trim();
		if (!address) return;

		const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${API_KEY}&language=ja`;

		try {
			const res = await fetch(url);
			const data = await res.json();

			if (data.results?.length > 0) {
				const loc = data.results[0].geometry.location;
				map.panTo({ lat: loc.lat, lng: loc.lng });
				map.setZoom(15);
			}
		} catch (e) {
			console.error("centerMapFromTextbox error:", e);
		}
	}
	
	function parseJapaneseAddress(input) {
		if (!input) return { pref: "", city: "" };

		let address = input.trim();

		// â‘  ä¸è¦ãƒ¯ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆå›½åãƒ»ã‚«ãƒ³ãƒãƒ»å…¨è§’ç©ºç™½ï¼‰
		address = address
			.replace(/^æ—¥æœ¬[ã€,\s]*/i, "")
			.replace(/JP[ã€,\s]*/i, "")
			.replace(/[ã€,]/g, " ")  // ã‚«ãƒ³ãƒ â†’ åŠè§’ã‚¹ãƒšãƒ¼ã‚¹
			.replace(/\s+/g, " ");  // é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’ 1 ã«

		// â‘¡ éƒµä¾¿ç•ªå·å‰Šé™¤ï¼ˆã€’699-2841 / 6992841 ä¸¡æ–¹å¯¾å¿œï¼‰
		address = address.replace(/ã€’?\d{3}-?\d{4}/g, "").trim();

		// â‘¢ éƒ½é“åºœçœŒæŠ½å‡º
		const prefRegex = /(åŒ—æµ·é“|æ±äº¬éƒ½|äº¬éƒ½åºœ|å¤§é˜ªåºœ|.{2,3}çœŒ)/;
		const prefMatch = address.match(prefRegex);
		let pref = prefMatch ? prefMatch[0] : "";

		// â‘£ å¸‚åŒºç”ºæ‘æŠ½å‡º
		let city = "";
		if (pref) {
			const remain = address.slice(address.indexOf(pref) + pref.length);
			const cityRegex = /(.*?[å¸‚åŒºç”ºæ‘])/;
			const cityMatch = remain.match(cityRegex);
			if (cityMatch) city = cityMatch[1];
		}

		return { pref, city };
	}
	

</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFsUzLKS7z-n6zAYK7gXf-mm6iVXGrT1A&callback=initMap"></script>
</body>
</html>



